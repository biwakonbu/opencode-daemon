#!/usr/bin/env bash
set -euo pipefail

echo "===== Pre-commit Hook ====="

swift_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.swift$' || true)

if [[ -z "$swift_files" ]]; then
  echo "No Swift files to check. Skipping pre-commit hook."
  exit 0
fi

echo ""
echo "Changed Swift files:"
echo "$swift_files"
echo ""

echo "[1/2] Running SwiftLint..."
if ! ./Scripts/lint.sh; then
  echo ""
  echo "❌ SwiftLint failed. Please fix the linting issues before committing." >&2
  echo "Run './Scripts/lint.sh' or 'swiftlint --fix' to fix automatically." >&2
  exit 1
fi
echo "✅ SwiftLint passed"
echo ""

echo "[2/2] Running swift-format (lint)..."
if ! swift format --version >/dev/null 2>&1; then
  echo "❌ swift format not available. Please install Xcode 15+ or a Swift toolchain." >&2
  exit 1
fi

if ! swift format lint --recursive --configuration .swift-format Sources Tests; then
  echo ""
  echo "❌ swift-format check failed. Please format your code before committing." >&2
  echo "Run './Scripts/format.sh' to fix automatically." >&2
  exit 1
fi
echo "✅ swift-format check passed"
echo ""

echo "✅ All pre-commit checks passed successfully!"
